<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ data.title or 'Anime Details' }} - NekoStream</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/detail.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Extra CSS untuk fix overflow */
        .detail-sidebar {
            min-width: 0;
            max-width: 100%;
            overflow: hidden;
        }
        
        .info-card {
            min-width: 0;
            max-width: 100%;
            overflow: hidden;
        }
        
        .info-list {
            min-width: 0;
            max-width: 100%;
            overflow: hidden;
        }
        
        .info-item {
            min-width: 0;
            max-width: 100%;
            overflow: hidden;
        }
        
        .info-value {
            min-width: 0;
            max-width: 100%;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            word-break: break-all !important;
            white-space: normal !important;
        }
        
        .genre-tags {
            min-width: 0;
            max-width: 100%;
        }
        
        .genre-tag {
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-sizes {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 0.5rem;
            min-width: 0;
            max-width: 100%;
        }
        
        .size-badge {
            background: rgba(99, 102, 241, 0.1);
            border-left: 3px solid var(--primary);
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            color: var(--text);
            display: block;
            word-break: break-all;
            line-height: 1.4;
            min-width: 0;
            max-width: 100%;
        }
        
        .size-badge:hover {
            background: rgba(99, 102, 241, 0.2);
        }
        
        .external-link {
            min-width: 0;
            max-width: 100%;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="detail-container">
        <button class="back-btn" onclick="window.history.back()">
            <i class="fas fa-arrow-left"></i> Back to Browse
        </button>

        <div class="detail-hero">
            {% if data.img %}
            <div class="hero-backdrop" style="background-image: url('{{ data.img }}')"></div>
            {% endif %}
            <div class="hero-overlay"></div>
            <div class="hero-content">
                <h1 class="detail-title">{{ data.title or 'Untitled Anime' }}</h1>
                {% if data.info %}
                <p class="detail-info">{{ data.info }}</p>
                {% endif %}
            </div>
        </div>

        <div class="detail-wrapper">
            {% if data.streams and data.streams|length > 0 %}
            <div class="player-section">
                <div class="player-header">
                    <h2><i class="fas fa-play-circle"></i> Watch Now</h2>
                    <div class="stream-selector">
                        {% for stream in data.streams %}
                        <button class="stream-btn {% if loop.index == 1 %}active{% endif %}" 
                                onclick="changeStream('{{ stream.url }}', this)">
                            <i class="fas fa-server"></i> {{ stream.name }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
                <div class="video-player">
                    <iframe src="{{ data.streams[0].url }}" 
                            allowfullscreen 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
                    </iframe>
                </div>
            </div>
            {% else %}
            <div class="player-section">
                <div class="no-stream-message">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>No streaming links available for this anime</p>
                </div>
            </div>
            {% endif %}

            <div class="detail-content">
                <div class="detail-main">
                    <div class="info-card">
                        <h3><i class="fas fa-book"></i> Synopsis</h3>
                        {% if data.sinopsis %}
                        <p>{{ data.sinopsis }}</p>
                        {% else %}
                        <p class="no-data">Synopsis not available for this anime.</p>
                        {% endif %}
                    </div>

                    {% if data.download and data.download|length > 0 %}
                    <div class="download-section">
                        <h3><i class="fas fa-download"></i> Download Options</h3>
                        {% for quality in data.download %}
                        <div class="download-quality">
                            <h4>{{ quality.title }}</h4>
                            <div class="download-links">
                                {% for link in quality.links %}
                                <a href="{{ link.link }}" target="_blank" class="download-btn">
                                    <i class="fas fa-cloud-download-alt"></i>
                                    {{ link.name }}
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <div class="detail-sidebar">
                    {% if data.img %}
                    <div class="poster-card">
                        <img src="{{ data.img }}" alt="{{ data.title }}" onerror="this.style.display='none'">
                    </div>
                    {% else %}
                    <div class="poster-card">
                        <div class="no-poster">
                            <i class="fas fa-image"></i>
                            <p>No poster available</p>
                        </div>
                    </div>
                    {% endif %}

                    <div class="info-card">
                        <h3>Information</h3>
                        <div class="info-list">
                            {% if data.genre and data.genre.strip() %}
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-tags"></i> Genre</span>
                                <div class="genre-tags">
                                    {% for genre in data.genre.split(', ') %}
                                    {% if genre.strip() %}
                                    <span class="genre-tag">{{ genre.strip() }}</span>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            {% if data.anime %}
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-tv"></i> Series</span>
                                <span class="info-value">{{ data.anime }}</span>
                            </div>
                            {% endif %}

                            {% if data.producers %}
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-film"></i> Producers</span>
                                <span class="info-value">{{ data.producers }}</span>
                            </div>
                            {% endif %}

                            {% if data.duration %}
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-clock"></i> Duration</span>
                                <span class="info-value">{{ data.duration }}</span>
                            </div>
                            {% endif %}

                            {% if data.size %}
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-hdd"></i> File Size</span>
                                <div class="file-sizes">
                                    {% set size_parts = data.size.split('|') %}
                                    {% for size in size_parts %}
                                    {% if size.strip() %}
                                    <span class="size-badge">{{ size.strip() }}</span>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    {% if data.streams and data.streams|length > 0 %}
                    <div class="info-card">
                        <h3><i class="fas fa-external-link-alt"></i> External Links</h3>
                        {% for stream in data.streams %}
                        <a href="{{ stream.url }}" target="_blank" class="external-link">
                            <i class="fas fa-play"></i> {{ stream.name }}
                        </a>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if data.anime %}
    <div class="related-section" id="relatedSection" style="display: none;">
        <div class="detail-wrapper">
            <h2 class="section-title">
                <i class="fas fa-list"></i> Other Episodes
            </h2>
            <div class="anime-grid" id="relatedEpisodes">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading episodes...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/detail.js') }}"></script>
    <script>
        const animeTitle = "{{ data.anime }}";
        if (animeTitle) {
            loadRelatedEpisodes(animeTitle);
        }
    </script>
    {% endif %}
</body>
</html>
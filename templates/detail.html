<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ data.title or 'Anime Details' }} - NekoStream</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/detail.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Extra CSS untuk fix overflow */
        .detail-sidebar {
            min-width: 0;
            max-width: 100%;
            overflow: hidden;
        }
        
        .info-card {
            min-width: 0;
            max-width: 100%;
            overflow: hidden;
        }
        
        .info-list {
            min-width: 0;
            max-width: 100%;
            overflow: hidden;
        }
        
        .info-item {
            min-width: 0;
            max-width: 100%;
            overflow: hidden;
        }
        
        .info-value {
            min-width: 0;
            max-width: 100%;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            word-break: break-all !important;
            white-space: normal !important;
        }
        
        .genre-tags {
            min-width: 0;
            max-width: 100%;
        }
        
        .genre-tag {
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-sizes {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 0.5rem;
            min-width: 0;
            max-width: 100%;
        }
        
        .size-badge {
            background: rgba(99, 102, 241, 0.1);
            border-left: 3px solid var(--primary);
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            color: var(--text);
            display: block;
            word-break: break-all;
            line-height: 1.4;
            min-width: 0;
            max-width: 100%;
        }
        
        .size-badge:hover {
            background: rgba(99, 102, 241, 0.2);
        }
        
        .external-link {
            min-width: 0;
            max-width: 100%;
            word-break: break-all;
        }

        .bookmark-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bookmark-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(99, 102, 241, 0.6);
        }

        .bookmark-btn.bookmarked {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
        }

        .bookmark-btn i {
            transition: all 0.3s ease;
        }

        .bookmark-btn.bookmarked i {
            animation: bookmarkPulse 0.5s ease;
        }

        @keyframes bookmarkPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }

        /* Fullscreen Floating Button CSS */
        .floating-fullscreen-btn {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .floating-fullscreen-btn:hover {
            background: rgba(99, 102, 241, 0.8);
            transform: scale(1.1);
        }

        .video-player {
            position: relative;
        }

        .video-player.fullscreen .floating-fullscreen-btn {
            bottom: 2rem;
            right: 2rem;
            width: 3rem;
            height: 3rem;
            font-size: 1.2rem;
            background: rgba(255, 255, 255, 0.2);
        }

        .video-player.fullscreen .floating-fullscreen-btn:hover {
            background: rgba(99, 102, 241, 0.9);
        }

        .video-player.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: black;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-player.fullscreen iframe {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
        }

        .video-player.fullscreen::after {
            content: 'Press ESC to exit fullscreen';
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .video-player.fullscreen:hover::after {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .bookmark-btn {
                width: 3rem;
                height: 3rem;
                font-size: 1.2rem;
                bottom: 1.5rem;
                right: 1.5rem;
            }
            
            .player-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .floating-fullscreen-btn {
                width: 2.2rem;
                height: 2.2rem;
                font-size: 0.9rem;
            }
            
            .video-player.fullscreen .floating-fullscreen-btn {
                width: 2.5rem;
                height: 2.5rem;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="detail-container">
        <button class="back-btn" onclick="window.history.back()">
            <i class="fas fa-arrow-left"></i> Back to Browse
        </button>

        <!-- Floating Bookmark Button -->
        <button class="bookmark-btn" id="bookmarkBtn" onclick="toggleDetailBookmark()" title="Bookmark this anime">
            <i class="far fa-bookmark"></i>
        </button>

        <div class="detail-hero">
            {% if data.img %}
            <div class="hero-backdrop" style="background-image: url('{{ data.img }}')"></div>
            {% endif %}
            <div class="hero-overlay"></div>
            <div class="hero-content">
                <h1 class="detail-title">{{ data.title or 'Untitled Anime' }}</h1>
                {% if data.info %}
                <p class="detail-info">{{ data.info }}</p>
                {% endif %}
            </div>
        </div>

        <div class="detail-wrapper">
            {% if data.streams and data.streams|length > 0 %}
            <div class="player-section">
                <div class="player-header">
                    <h2><i class="fas fa-play-circle"></i> Watch Now</h2>
                    <div class="stream-selector">
                        {% for stream in data.streams %}
                        <button class="stream-btn {% if loop.index == 1 %}active{% endif %}" 
                                onclick="changeStream('{{ stream.url }}', this)">
                            <i class="fas fa-server"></i> {{ stream.name }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
                <div class="video-player">
                    <iframe src="{{ data.streams[0].url }}" 
                            allowfullscreen 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
                    </iframe>
                    <button class="floating-fullscreen-btn" onclick="toggleFullscreen()" title="Toggle Fullscreen">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            {% else %}
            <div class="player-section">
                <div class="no-stream-message">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>No streaming links available for this anime</p>
                </div>
            </div>
            {% endif %}

            <div class="detail-content">
                <div class="detail-main">
                    <div class="info-card">
                        <h3><i class="fas fa-book"></i> Synopsis</h3>
                        {% if data.sinopsis %}
                        <p>{{ data.sinopsis }}</p>
                        {% else %}
                        <p class="no-data">Synopsis not available for this anime.</p>
                        {% endif %}
                    </div>

                    {% if data.download and data.download|length > 0 %}
                    <div class="download-section">
                        <h3><i class="fas fa-download"></i> Download Options</h3>
                        {% for quality in data.download %}
                        <div class="download-quality">
                            <h4>{{ quality.title }}</h4>
                            <div class="download-links">
                                {% for link in quality.links %}
                                <a href="{{ link.link }}" target="_blank" class="download-btn">
                                    <i class="fas fa-cloud-download-alt"></i>
                                    {{ link.name }}
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <div class="detail-sidebar">
                    {% if data.img %}
                    <div class="poster-card">
                        <img src="{{ data.img }}" alt="{{ data.title }}" onerror="this.style.display='none'">
                    </div>
                    {% else %}
                    <div class="poster-card">
                        <div class="no-poster">
                            <i class="fas fa-image"></i>
                            <p>No poster available</p>
                        </div>
                    </div>
                    {% endif %}

                    <div class="info-card">
                        <h3>Information</h3>
                        <div class="info-list">
                            {% if data.genre and data.genre.strip() %}
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-tags"></i> Genre</span>
                                <div class="genre-tags">
                                    {% for genre in data.genre.split(', ') %}
                                    {% if genre.strip() %}
                                    <span class="genre-tag">{{ genre.strip() }}</span>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            {% if data.anime %}
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-tv"></i> Series</span>
                                <span class="info-value">{{ data.anime }}</span>
                            </div>
                            {% endif %}

                            {% if data.producers %}
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-film"></i> Producers</span>
                                <span class="info-value">{{ data.producers }}</span>
                            </div>
                            {% endif %}

                            {% if data.duration %}
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-clock"></i> Duration</span>
                                <span class="info-value">{{ data.duration }}</span>
                            </div>
                            {% endif %}

                            {% if data.size %}
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-hdd"></i> File Size</span>
                                <div class="file-sizes">
                                    {% set size_parts = data.size.split('|') %}
                                    {% for size in size_parts %}
                                    {% if size.strip() %}
                                    <span class="size-badge">{{ size.strip() }}</span>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    {% if data.streams and data.streams|length > 0 %}
                    <div class="info-card">
                        <h3><i class="fas fa-external-link-alt"></i> External Links</h3>
                        {% for stream in data.streams %}
                        <a href="{{ stream.url }}" target="_blank" class="external-link">
                            <i class="fas fa-play"></i> {{ stream.name }}
                        </a>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if data.anime %}
    <div class="related-section" id="relatedSection" style="display: none;">
        <div class="detail-wrapper">
            <h2 class="section-title">
                <i class="fas fa-list"></i> Other Episodes
            </h2>
            <div class="anime-grid" id="relatedEpisodes">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading episodes...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/detail.js') }}"></script>
    <script>
        const animeTitle = "{{ data.anime }}";
        if (animeTitle) {
            loadRelatedEpisodes(animeTitle);
        }
    </script>
    {% endif %}

    <script>
        // Bookmark functionality for detail page
        const currentAnimeUrl = new URLSearchParams(window.location.search).get('url');
        
        // Get image from poster card instead of template variable
        const posterImg = document.querySelector('.poster-card img');
        const imgUrl = posterImg ? posterImg.src : '';
        
        const animeData = {
            title: `{{ data.title or 'Untitled Anime' }}`.replace(/&#39;/g, "'").replace(/&quot;/g, '"').replace(/&amp;/g, '&'),
            url: currentAnimeUrl || '',
            img: imgUrl,
            info: `{{ data.info or '' }}`.replace(/&#39;/g, "'").replace(/&quot;/g, '"').replace(/&amp;/g, '&'),
            genre: `{{ data.genre or '' }}`
        };
        
        // Debug log
        console.log('Anime data to bookmark:', animeData);
        console.log('Image URL:', imgUrl);

        function toggleDetailBookmark() {
            const BOOKMARKS_KEY = 'nekostream_bookmarks';
            const bookmarks = JSON.parse(localStorage.getItem(BOOKMARKS_KEY) || '[]');
            const existingIndex = bookmarks.findIndex(b => b.url === animeData.url);
            const btn = document.getElementById('bookmarkBtn');
            const icon = btn.querySelector('i');
            
            if (existingIndex > -1) {
                bookmarks.splice(existingIndex, 1);
                icon.className = 'far fa-bookmark';
                btn.classList.remove('bookmarked');
                btn.title = 'Bookmark this anime';
                showDetailNotification('Removed from bookmarks', 'info');
            } else {
                bookmarks.push({
                    ...animeData,
                    timestamp: new Date().toISOString()
                });
                icon.className = 'fas fa-bookmark';
                btn.classList.add('bookmarked');
                btn.title = 'Remove from bookmarks';
                showDetailNotification('Added to bookmarks!', 'success');
            }
            
            localStorage.setItem(BOOKMARKS_KEY, JSON.stringify(bookmarks));
        }

        function checkDetailBookmarkStatus() {
            const BOOKMARKS_KEY = 'nekostream_bookmarks';
            const bookmarks = JSON.parse(localStorage.getItem(BOOKMARKS_KEY) || '[]');
            const isBookmarked = bookmarks.some(b => b.url === animeData.url);
            const btn = document.getElementById('bookmarkBtn');
            const icon = btn.querySelector('i');
            
            if (isBookmarked) {
                icon.className = 'fas fa-bookmark';
                btn.classList.add('bookmarked');
                btn.title = 'Remove from bookmarks';
            }
        }

        function showDetailNotification(message, type = 'info') {
            const existing = document.querySelector('.detail-notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.className = 'detail-notification';
            notification.style.cssText = `
                position: fixed;
                top: 2rem;
                right: 2rem;
                background: ${type === 'success' ? '#10b981' : '#6366f1'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // Check bookmark status on page load
        checkDetailBookmarkStatus();

        // Fullscreen functionality
        let isFullscreen = false;

        function toggleFullscreen() {
            const videoPlayer = document.querySelector('.video-player');
            const fullscreenBtn = document.querySelector('.floating-fullscreen-btn');
            const icon = fullscreenBtn.querySelector('i');
            
            if (!isFullscreen) {
                // Enter fullscreen
                videoPlayer.classList.add('fullscreen');
                icon.className = 'fas fa-compress';
                fullscreenBtn.title = 'Exit Fullscreen';
                isFullscreen = true;
                
                // Add ESC key listener
                document.addEventListener('keydown', handleEscapeKey);
                
                // Hide bookmark button when in fullscreen
                const bookmarkBtn = document.getElementById('bookmarkBtn');
                if (bookmarkBtn) bookmarkBtn.style.display = 'none';
            } else {
                // Exit fullscreen
                exitFullscreen();
            }
        }

        function exitFullscreen() {
            const videoPlayer = document.querySelector('.video-player');
            const fullscreenBtn = document.querySelector('.floating-fullscreen-btn');
            const icon = fullscreenBtn.querySelector('i');
            
            videoPlayer.classList.remove('fullscreen');
            icon.className = 'fas fa-expand';
            fullscreenBtn.title = 'Toggle Fullscreen';
            isFullscreen = false;
            
            // Remove ESC key listener
            document.removeEventListener('keydown', handleEscapeKey);
            
            // Show bookmark button again
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            if (bookmarkBtn) bookmarkBtn.style.display = 'flex';
        }

        function handleEscapeKey(event) {
            if (event.key === 'Escape' && isFullscreen) {
                exitFullscreen();
            }
        }

        // Enable double-click on video to toggle fullscreen
        document.addEventListener('DOMContentLoaded', function() {
            const videoPlayer = document.querySelector('.video-player');
            
            if (videoPlayer) {
                videoPlayer.addEventListener('dblclick', function(e) {
                    // Cegah double-click pada tombol fullscreen itu sendiri
                    if (!e.target.closest('.floating-fullscreen-btn')) {
                        toggleFullscreen();
                    }
                });
            }
        });
    </script>

    <style>
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
    <script src="https://pl28642644.effectivegatecpm.com/85/fb/f6/85fbf6ff57a100f6ec1a8fd4c48b9652.js"></script>
</body>
</html>
